include ../../config.mk

LINKFLAGS += -L../common

LIBS += -lcommon

ALL_SOURCE := $(wildcard *.cc)
ALL_OBJECTS := $(wildcard *.o)

# Each .o file will have a corresponding .d file
DEPS := $(ALL_SOURCE:.cc=.d)

CAMERA_CONTROL_BIN := camera_control_bin
UNIT_TEST_BIN := unit_tests_bin

ALL_BIN := $(CAMERA_CONTROL_BIN) $(UNIT_TEST_BIN)

.PHONY: all
all: $(ALL_BIN)

CAMERA_CONTROL_BIN_SRC := $(filter-out $(wildcard *uto*cc), $(ALL_SOURCE))
CAMERA_CONTROL_BIN_OBJS := $(CAMERA_CONTROL_BIN_SRC:.cc=.o)

UNIT_TEST_BIN_SRC := $(wildcard *uto*cc)
UNIT_TEST_BIN_SRC += Camera.cc
UNIT_TEST_BIN_SRC += CameraControl.cc
UNIT_TEST_BIN_SRC += CameraSequence.cc
UNIT_TEST_BIN_SRC += CameraSequenceFileReader.cc
UNIT_TEST_BIN_OBJS := $(UNIT_TEST_BIN_SRC:.cc=.o)

# Make all the unit test objects depend on the C++ module:
$(UNIT_TEST_BIN_OBJS): $(UNIT_TEST_MODULE_OBJ)

$(CAMERA_CONTROL_BIN): $(CAMERA_CONTROL_BIN_OBJS) ../common/libcommon.a
	@echo "$(LINK_COLOR)Linking$(RESET) $@"
	$(SILENT)$(CXX) -o $(CAMERA_CONTROL_BIN) $(CAMERA_CONTROL_BIN_OBJS) $(LINKFLAGS) $(LIBS)

$(UNIT_TEST_BIN): $(ALL_SOURCE) $(UNIT_TEST_BIN_OBJS) ../common/libcommon.a
	@echo "$(LINK_COLOR)Linking$(RESET) $@"
	$(SILENT)$(CXX) -o $(UNIT_TEST_BIN) $(UNIT_TEST_BIN_OBJS) $(LINKFLAGS) $(LIBS)

test: $(UNIT_TEST_BIN)
	./$(UNIT_TEST_BIN)

clean:
	@echo "$(CLEAN_COLOR)Cleaning$(RESET) $(shell pwd)"
	$(SILENT)rm -f $(ALL_BIN) $(ALL_OBJECTS) $(DEPS)

dump:
	@echo All_SOURCE: $(ALL_SOURCE)
	@echo
	@echo CAMERA_CONTROL_BIN: $(CAMERA_CONTROL_BIN)
	@echo
	@echo CAMERA_CONTROL_BIN_SRC: $(CAMERA_CONTROL_BIN_SRC)
	@echo
	@echo CAMERA_CONTROL_BIN_OBJS: $(CAMERA_CONTROL_BIN_OBJS)
	@echo
	@echo UNIT_TEST_BIN: $(UNIT_TEST_BIN)
	@echo
	@echo UNIT_TEST_BIN_SRC: $(UNIT_TEST_BIN_SRC)
	@echo
	@echo UNIT_TEST_BIN_OBJS: $(UNIT_TEST_BIN_OBJS)
	@echo

# KEEP at the end so %.o rule doesn't overwrite the dependcy tracking
# rules generated by the compiler.
-include $(DEPS)

# :mode=Makefile: