include ../../config.mk

EXTERNAL_DIR = $(ROOT_DIR)external

CPPINCLUDES = -I.. -I$(EXTERNAL_DIR)/include

LINKFLAGS = \
    -L../common \
	-L$(EXTERNAL_DIR)/lib \
	-Wl,-rpath,$(abspath $(EXTERNAL_DIR)/lib)

LIBS = \
    -lcommon \
    -lgphoto2 \
    -lgphoto2_port \
    -lgphoto2_port \
    -lcactus_rt \
    -lcactus_tracing_embedded_perfetto_protos \
    -lquill \
	-lprotobuf \
	-lpthread \
	-lCatch2 \
	-lCatch2Main

ALL_SOURCE = $(wildcard *.cc)
ALL_OBJECTS = $(wildcard *.o)

# Each .o file will have a corresponding .d file
DEPS = $(ALL_SOURCE:.cc=.d)

CAMERA_CONTROL_BIN := camera_control_bin
UNIT_TEST_BIN := unit_tests_bin

ALL_BIN := $(CAMERA_CONTROL_BIN) $(UNIT_TEST_BIN)

.PHONY: all
all: $(ALL_BIN)

CAMERA_CONTROL_BIN_SRC := $(filter-out %_uto.cc, $(ALL_SOURCE))
CAMERA_CONTROL_BIN_OBJS := $(CAMERA_CONTROL_BIN_SRC:.cc=.o)

UNIT_TEST_BIN_SRC := $(wildcard *_uto.cc)
UNIT_TEST_BIN_OBJS := $(UNIT_TEST_BIN_SRC:.cc=.o)

%.o: %.cc
	@echo "$(BUILD_COLOR)Building$(RESET) $<"
	$(SILENT)$(CXX) $(CXXFLAGS) $(CPPINCLUDES) -c $< -o $@

$(CAMERA_CONTROL_BIN): $(CAMERA_CONTROL_BIN_OBJS) ../common/libcommon.a
	@echo "$(LINK_COLOR)Linking$(RESET) $@"
	$(SILENT)$(CXX) -o $(CAMERA_CONTROL_BIN) $(CAMERA_CONTROL_BIN_OBJS) $(LINKFLAGS) $(LIBS)

$(UNIT_TEST_BIN): $(ALL_SOURCE) $(UNIT_TEST_BIN_OBJS) CameraSequenceFileReader.o ../common/libcommon.a
	@echo "$(LINK_COLOR)Linking$(RESET) $@"
	$(SILENT)$(CXX) -o $(UNIT_TEST_BIN) $(UNIT_TEST_BIN_OBJS) CameraSequenceFileReader.o $(LINKFLAGS) $(LIBS)

test: $(UNIT_TEST_BIN)
	./$(UNIT_TEST_BIN)

clean:
	@echo "$(CLEAN_COLOR)Cleaning$(RESET)"
	$(SILENT)rm -f $(ALL_BIN) $(ALL_OBJECTS) $(DEPS)

dump:
	@echo $(CAMERA_CONTROL_BIN)
	@echo $(CAMERA_CONTROL_BIN_SRC)
	@echo $(CAMERA_CONTROL_BIN_OBJS)
	@echo $(UNIT_TEST_BIN)
	@echo $(UNIT_TEST_BIN_SRC)
	@echo $(UNIT_TEST_BIN_OBJS)

# KEEP at the end so %.o rule doesn't overwrite the dependcy tracking
# rules generated by the compiler.
-include $(DEPS)

# :mode=Makefile: